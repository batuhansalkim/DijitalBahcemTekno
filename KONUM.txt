SÃ¼per fikir! ğŸ¯ AÄŸaÃ§taki RFID etiketin UIDâ€™sini NFC ile okurken, aynÄ± anda telefondan coÄŸrafi konumu (WGS84) alÄ±p veritabanÄ±na tek bir kayÄ±t olarak yazmanÄ±z yeterli. AÅŸaÄŸÄ±da hem doÄŸru veri modeli hem de React Native/Expo (Ã¶nerilir) tarafÄ± iÃ§in Ã§alÄ±ÅŸÄ±r bir akÄ±ÅŸ bÄ±raktÄ±m.

1) Hangi formatta saklamalÄ±yÄ±m?

Koordinat sistemi: WGS84 (telefonlarÄ±n verdiÄŸi standart).

Lat/Lon formatÄ±: OndalÄ±klÄ± derece (decimal degrees).

Ã–rn: lat: 37.123456, lon: 33.654321

6 ondalÄ±k saklayÄ±n â†’ ~11 cm duyarlÄ±lÄ±k (5 ondalÄ±k â‰ˆ 1.1 m).

Zaman damgasÄ±: ISO-8601 UTC (2025-09-07T07:15:23Z)

DoÄŸruluk: metre cinsinden (telefon SDKâ€™sÄ± verir).

Opsiyonel: yÃ¼kseklik (altitude, m), hÄ±z, heading.

Ã–rnek JSON
{
  "rfid_uid": "04A224FC3B2980",
  "tree_id": "TR-URF-000123",
  "lat": 37.123456,
  "lon": 33.654321,
  "alt": 487.3,
  "accuracy_m": 2.4,
  "collected_at_utc": "2025-09-07T07:15:23Z",
  "source": "mobile_gps",
  "notes": "Zeytin aÄŸacÄ± kuzey sÄ±nÄ±r",
  "user_id": "ahmetc"
}

2) VeritabanÄ± ÅŸemasÄ± (PostgreSQL + PostGIS Ã¶nerilir)

Neden? MekÃ¢nsal sorgular (Ã¶r. â€œÃ§iftliÄŸin poligonu iÃ§indeki tÃ¼m aÄŸaÃ§larâ€), mesafe, yakÄ±nlÄ±k vb. Ã§ok kolaylaÅŸÄ±r.

-- PostGIS yÃ¼klÃ¼ olmalÄ±: CREATE EXTENSION postgis;
CREATE TABLE trees (
  id SERIAL PRIMARY KEY,
  rfid_uid VARCHAR(32) UNIQUE NOT NULL,
  tree_code VARCHAR(64),                -- sizin iÃ§ kodunuz (opsiyonel)
  geom GEOGRAPHY(POINT, 4326) NOT NULL, -- WGS84, lat/lon
  lat NUMERIC(9,6) GENERATED ALWAYS AS (ST_Y(geom::geometry)) STORED,
  lon NUMERIC(9,6) GENERATED ALWAYS AS (ST_X(geom::geometry)) STORED,
  altitude_m NUMERIC(7,2),
  accuracy_m NUMERIC(7,2),
  collected_at_utc TIMESTAMPTZ NOT NULL DEFAULT now(),
  source TEXT DEFAULT 'mobile_gps',
  notes TEXT,
  created_by TEXT
);

-- HÄ±zlÄ± mekÃ¢nsal sorgu iÃ§in indeks
CREATE INDEX idx_trees_geom ON trees USING GIST(geom);
CREATE UNIQUE INDEX idx_trees_rfid ON trees (rfid_uid);


PostGIS kullanmayacaksanÄ±z, en azÄ±ndan lat NUMERIC(9,6), lon NUMERIC(9,6), accuracy_m, collected_at_utc alanlarÄ± olsun.

3) Mobil tarafta konum alma (Expo Ã¶nerisi)

Expo kullanÄ±yorsanÄ±z expo-location ile tek satÄ±rda iÅŸ:

expo install expo-location

// Konum + NFC entegrasyon Ã¶rneÄŸi (TypeScript, Expo)
import * as Location from 'expo-location';
import { useState, useCallback } from 'react';
import { Alert } from 'react-native';

type GpsFix = {
  lat: number;
  lon: number;
  alt?: number | null;
  accuracy_m?: number | null;
  timestamp: string; // ISO-8601 UTC
};

async function getGpsFix(): Promise<GpsFix> {
  const { status } = await Location.requestForegroundPermissionsAsync();
  if (status !== 'granted') {
    throw new Error('Konum izni verilmedi.');
  }

  // YÃ¼ksek doÄŸruluk ve taze konum
  const pos = await Location.getCurrentPositionAsync({
    accuracy: Location.Accuracy.Highest,
    mayShowUserSettingsDialog: true,
  });

  const lat = Number(pos.coords.latitude.toFixed(6));
  const lon = Number(pos.coords.longitude.toFixed(6));

  return {
    lat,
    lon,
    alt: pos.coords.altitude ?? null,
    accuracy_m: pos.coords.accuracy ?? null,
    timestamp: new Date(pos.timestamp).toISOString(),
  };
}

// NFC hookâ€™unuzdan okunan uid ile birlikte kaydetme akÄ±ÅŸÄ±
export async function captureTreePointAndSave(readRfidUid: () => Promise<string>) {
  try {
    const uid = await readRfidUid();           // Ã–rn: useNfcReader() iÃ§inde NDEF/ISO dep.
    const fix = await getGpsFix();

    // Basit aralÄ±k doÄŸrulamasÄ±
    if (fix.lat < -90 || fix.lat > 90 || fix.lon < -180 || fix.lon > 180) {
      throw new Error('GeÃ§ersiz koordinat aralÄ±ÄŸÄ±.');
    }

    const payload = {
      rfid_uid: uid,
      lat: fix.lat,
      lon: fix.lon,
      alt: fix.alt,
      accuracy_m: fix.accuracy_m,
      collected_at_utc: fix.timestamp,
      source: 'mobile_gps',
    };

    // Sunucuya yolla (Ã¶rnek)
    await fetch('https://api.sizin-domain.com/trees', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    Alert.alert('BaÅŸarÄ±lÄ±', `AÄŸaÃ§ kaydedildi\nUID: ${uid}\n${fix.lat}, ${fix.lon}`);
  } catch (e: any) {
    Alert.alert('Hata', e.message ?? 'Bilinmeyen hata');
  }
}

Android/iOS izinleri

Android (Expo yÃ¶netimli): app.json/app.config.ts iÃ§inde android.permissions genelde otomatik; gerekirse ACCESS_FINE_LOCATION.

iOS: NSLocationWhenInUseUsageDescription aÃ§Ä±klama metni ekleyin.

4) NFC + konum tek tuÅŸ akÄ±ÅŸÄ± (UX Ã¶nerisi)

â€œAÄŸacÄ± Taraâ€ â†’ NFC okuma baÅŸlar.

UID okununca otomatik konum alÄ±nÄ±r (spinner gÃ¶ster).

DoÄŸruluk > 10 m ise kullanÄ±cÄ±ya â€œKonum zayÄ±f, tekrar deneâ€ uyarÄ±sÄ± (isteÄŸe baÄŸlÄ± eÅŸik: 5â€“10 m).

KaydÄ± POST et ve baÅŸarÄ± mesajÄ± gÃ¶ster.

Offline mod: Sunucu yoksa, payloadâ€™larÄ± AsyncStorage kuyruÄŸuna yaz; internet gelince senkronize et.

5) Alternatif depolama formatlarÄ± (gerekirse)

GeoJSON (harici paylaÅŸÄ±m/harita iÃ§in ÅŸahane):

{
  "type": "Feature",
  "geometry": { "type": "Point", "coordinates": [33.654321, 37.123456] },
  "properties": { "rfid_uid": "04A224FC3B2980", "accuracy_m": 2.4, "collected_at_utc": "2025-09-07T07:15:23Z" }
}


WKT (PostGIS ile uyumlu): POINT(33.654321 37.123456)

6) DoÄŸruluk ve kalite ipuÃ§larÄ±

6 ondalÄ±k saklayÄ±n (â‰ˆ 0.11 m).

AÄŸaÃ§ sabit nesne olduÄŸu iÃ§in tek seferlik iyi koÅŸullarda (aÃ§Ä±k gÃ¶kyÃ¼zÃ¼) kayÄ±t almanÄ±z yeterli.

Konum 2â€“5 m doÄŸruluk altÄ±nda deÄŸilse yeniden Ã¶lÃ§Ã¼m alÄ±n veya ortalama alÄ±n (2â€“3 Ã¶lÃ§Ã¼m).

AÄŸaÃ§larÄ± haritada gÃ¶stermek iÃ§in sonradan tile server/Google Maps/Leaflet kullanabilirsiniz (PostGISâ€™ten GeoJSON Ã§Ä±karÄ±p).

7) Sunucu tarafÄ±nda ek gÃ¼venlik/iÅŸ mantÄ±ÄŸÄ±

rfid_uid UNIQUE olsun (aynÄ± etiketi iki aÄŸaca baÄŸlamasÄ±n).

accuracy_m > 50 gibi Ã§ok zayÄ±f Ã¶lÃ§Ã¼mleri reddedin.

API giriÅŸinde lat/lon aralÄ±ÄŸÄ± kontrol edin.

KullanÄ±cÄ±/rol bazlÄ± yetki (kim ekledi/gÃ¼ncelledi).